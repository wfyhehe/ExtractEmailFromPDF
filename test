@csrf_exempt
@cannot_submit_after_contest_ended
def submit(request, problem):
    if not request.user.is_authenticated():
        return JsonResponse({
            'success': False,
            'message': 'login required',
            'redirect_uri': '/accounts/signin/?next=/problem/'
        })

    if 'language' not in request.POST or 'code' not in request.POST:
        return JsonResponse({
            'success': False,
            'message': 'Language and code are necessary when submitted.'
        })

    user = request.user
    if _is_submit_out_of_limit(request, 'user'):
        return JsonResponse({
            'success': False,
            'message': _('You submitted too fast, please wait a minute :)')
        })

    submission_params = {
        'user': user,
        'language': request.POST['language'],
        'problem_id': problem.id,
        'code': request.POST['code'],
        'code_length': len(request.POST['code']),
        'session': user.profile.session
    }

    is_test_submission = 'is_test_submission' in request.POST
    if is_test_submission:
        submission_params['input'] = request.POST.get('input', '')
        del submission_params['session']
        del submission_params['code_length']
        submission = TestSubmission.objects.create(**submission_params)
    else:
        submission = Submission.objects.create(**submission_params)
        submission_created_signal.send(sender=None, submission=submission)
        if submission.user and not settings.DEBUG:
            SubmissionService.upload_submission_to_s3(submission, async=False)

    judger = _get_judger(submission.language, is_test_submission)

    # TODO: deprecate cloudjudge gatekeeper
    codetemplate = problem.get_codetemplate(language=submission.language)
    if codetemplate is None:
        return JsonResponse({'id': submission.id, 'success': False})

    judge_params = {
        'submission_id': submission.id,
        'user_id': submission.user_id,
        'problem_id': submission.problem_id,
        'language': submission.language,
        'main_code': codetemplate.main,
        'solution_code': submission.code,
        'time_limit': codetemplate.get_time_limit(submission.language) or problem.time_limit,
        'memory_limit': codetemplate.get_memory_limit(submission.language) or problem.memory_limit,
        'classname': codetemplate.classname,
        'common_code': codetemplate.common_code,
        'common_classname': codetemplate.common_classname,
        'secret_key': get_secret_key(submission.id),
        'created_at': utc_to_int(submission.created_at),
    }

    if is_test_submission:
        judge_params['input'] = submission.input
        judge_params['standard'] = codetemplate.standard
        judge_params['is_test_submission'] = True

    if settings.DEV:
        mock_judge(judge_params)
        return JsonResponse({'id': submission.id, 'success': True})

    judger.delay(judge_params)

    measure_manager.count('submission.submit',
                          tags={
                              'language': submission.language,
                              'is_test_submission': is_test_submission,
                              'problem_id': submission.problem_id,
                          },
                          fields={
                              'submission_id': submission.id,
                              'user_id': submission.user_id,
                          })

    return JsonResponse({'id': submission.id, 'success': True})
